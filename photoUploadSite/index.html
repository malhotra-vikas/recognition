<!DOCTYPE html>
<html>
<head>
<title>Image Upload</title>
<link rel="stylesheet" type="text/css" href="styles.css"> <!-- Link to styles.css -->

</head>
<body>
	<h1>Image Upload</h1>
	<form id="uploadForm" enctype="multipart/form-data">
		<label for="eventName">Event Name:</label> 
		<select id="eventName" name="eventName" required></select> 
			<br> <br> 
		<label
			for="photographerName">Photographer Name:</label> 
			<select id="photographerName" name="photographerName" required></select> 
			<br> <br> 
		<label for="imageFolder">Select a Local Folder:</label> 
		<input
			type="file" id="imageFolder" name="imageFolder" webkitdirectory
			directory multiple accept="image/jpeg" required> <br> <br>
		<input type="submit" value="Upload Images">

        <div id="spinner-container" class="spinner-container">
            <div class="spinner"></div>
        </div>

        <div id="progress">
            <div id="progress-bar"></div>
            <p id="progress-text">0 / 0</p>
        </div>
        <span id="completionNotification" style="color: red;"></span>
        <span id="elapsedTime" style="color: red;"></span>

		
	</form>

	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1152.0/aws-sdk.min.js"></script>
	<script>
	
		AWS.config.region = 'us-east-2'; // Replace with your desired region
		AWS.config.credentials = new AWS.CognitoIdentityCredentials({
			IdentityPoolId : 'us-east-2:48eebc1f-183c-4a21-b1d3-aed2062eab7f' // Replace with your Cognito Identity Pool ID
			});
		
        // Function to show the spinner
        function showSpinner() {
            document.getElementById("spinner-container").style.display = "flex";
        }

        // Function to hide the spinner
        function hideSpinner() {
            document.getElementById("spinner-container").style.display = "none";
        }

        function updateProgressBarAndCount(completedUploads, imageFolderLength) {
            // Calculate the progress percentage
            var percent = (completedUploads / imageFolderLength) * 100;

            // Update the progress bar width
            document.getElementById("progress-bar").style.width = percent + "%";

            // Update the count text
            document.getElementById("progress-text").textContent = completedUploads + " / " + imageFolderLength;
        }

    	function handleFormSubmission(event) {
            event.preventDefault();
            showSpinner();

            var eventName = document.getElementById("eventName").value;
            var photographerName = document.getElementById("photographerName").value;
            var imageFolder = document.getElementById("imageFolder").files;
            var error = 0;
            var completedUploads = 0;
            var startTime = new Date();
            var skippedCount = 0;

            if (imageFolder.length === 0) {
                alert("Please select a local folder with JPG images.");
                return;
            }

         
            function handleUploadCompletion(error, skippedCount, startTime) {
                var endTime = new Date();
                var timeTakenMilliseconds = endTime - startTime;
                var hours = Math.floor(timeTakenMilliseconds / 3600000);
                var minutes = Math.floor((timeTakenMilliseconds % 3600000) / 60000);
                var seconds = Math.floor((timeTakenMilliseconds % 60000) / 1000);

                console.log("Time taken for upload: " + hours + " hours " + minutes + " minutes " + seconds + " seconds");
                document.getElementById("elapsedTime").textContent = "Time taken for upload: " + hours + " hours " + minutes + " minutes " + seconds + " seconds";
                 
                if (error == 1) {
                    document.getElementById("completionNotification").textContent = "An error occured while uploading images.";
                } else {
                    document.getElementById("completionNotification").textContent = "Successfully uploaded all images. Skipped uploading " + skippedCount + " images as these were already uploaded"; 
                }
                    // Hide the spinner when the upload is complete
                hideSpinner();
            }
            
            // Function to recursively upload images to S3
            function uploadImages(index) {
                if (index < imageFolder.length) {
                    var file = imageFolder[index];
                    var fileName = file.webkitRelativePath; // Get the full path of the image
                    var fileExtension = fileName.split('.').pop(); // Get the file extension
                    var imageName = fileName.split("/").pop();
                    var message = eventName+":"+photographerName+":"+imageName;
                    

                    // Check if the image already exists in S3
                    var s3ObjectKey = `${eventName}/${photographerName}/${imageName}`;
                    s3.headObject({ Bucket: 'mediastore.primary.1', Key: s3ObjectKey }, function (err, data) {
                        if (!err) {
                            // Object exists in S3, skip to the next image
                            uploadImages(index + 1);
                            skippedCount = skippedCount+1;
                            console.log("Skipping upload for image, Skipped count " + skippedCount);

                        } else {
                            if (fileExtension.toLowerCase() === 'jpg' || fileExtension.toLowerCase() === 'jpeg') {
                                var params = {
                                    Bucket: 'mediastore.primary.1', // Replace with your S3 bucket name
                                    Key: `${eventName}/${photographerName}/${imageName}`, // S3 object key
                                    //Key: `${eventName}/${photographerName}/${file}`, // S3 object key
                                    Body: file // Image file to upload
                                };

                                const sqsMessageParams = {
                                    QueueUrl: 'https://sqs.us-east-2.amazonaws.com/018701121298/ImagesUploaded1',
                                    MessageBody: message
                                };
                                console.log("Uploading" + params.Key);

                                s3.upload(params, function (err, data) {
                                    if (err) {
                                        console.error("Error uploading image:", err);
                                        error = 1;
                                    } else {
                                        console.log("Image uploaded successfully:", data.Location);
                                        uploadImages(index + 1); // Upload the next image

                                        // Update the progress bar and count
                                        updateProgressBarAndCount(index + 1, imageFolder.length);


                                        // Now send the message to the queue
                                        sqs.sendMessage(sqsMessageParams, (err, data) => {
                                            if (err) {
                                                console.log(err);
                                                error = 1;
                                            } else {
                                                console.log('Message sent successfully.');
                                            }
                                        });
            
                                        console.log("Message being sent is "+ message);
                                    }
                                }).on('httpUploadProgress', function (progress) {
                                    // Calculate the progress percentage
                                    var percent = (progress.loaded / progress.total) * 100;

                                    // Update the progress bar width
                                    document.getElementById("progress-bar").style.width = percent + "%";
                                });
                            } else {
                                // Skip non-JPG files
                                uploadImages(index + 1);
                            }

                        }
                    });
                    // Increment the completedUploads count
                    completedUploads++;
                    
                    // Check if all uploads are completed
                    if (completedUploads === imageFolder.length) {
                        handleUploadCompletion(error, skippedCount, startTime);
                    }
                }

            }
            
            // Start uploading images
            uploadImages(0);
            
        };
    </script>

	<script src="app.js?v=1"></script>
</body>
</html>
